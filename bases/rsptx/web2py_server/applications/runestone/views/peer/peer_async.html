{{extend 'runestone.html'}}
<script>
  window.DISABLE_LLMTEST = true;
  window.PI_LLM_MODE = false;
</script>
<script>
  window.PI_LLM_MODE = false;
  window.DISABLE_LLMTEST = true;

  window.eBookConfig = window.eBookConfig || {};
  eBookConfig.course = "{{=course_id}}";
  eBookConfig.basecourse = "{{=course.base_course}}";
  eBookConfig.host = window.location.origin;
  eBookConfig.isLoggedIn = true;
</script>

<!-- <script>
window.eBookConfig = window.eBookConfig || {};
eBookConfig.course = "{{=course_id}}";
eBookConfig.basecourse = "{{=course.base_course}}";
eBookConfig.host = window.location.origin;
eBookConfig.isLoggedIn = true;
</script> -->

{{ if has_vote1: }}
  <p><em>Vote 1 detected</em></p>
{{ else: }}
  <p><em>No vote yet</em></p>
{{ pass }}
<div id="peer_async_root" data-div_id="{{=current_question.name}}">
</div>

{{extend 'layout.html'}}
{{block moreincludes}}
{{include '_sphinx_static_files.html'}}
{{end}}

<script>
    eBookConfig.peer = true;
    eBookConfig.peerMode = "async";
</script>

<div class="hidden-content" style="display: none">
    \( {{=XML(latex_macros)}} \)
 </div>

<h2>Peer Instruction Question (After Class)</h2>
<div id="imessage">
    <p>This page is meant for you to use <i>after</i> the inclass peer instruction is over.
        <ol>
            <li>Answer the question as best you can.</li>
            <li>Then, in the space provided write a justification for your answer.</li>
            <li>Read the dialog between two of your peers on why they answered the question the way they did.</li>
            <li>Answer the question <strong>again.</strong>  Even if you are not changing your answer from the first time.</li>
        </ol>
    </p>
</div> 

<div class="row">
    {{ if all_done == "false": }}
    <div class="oneq col-md-6 runestone-sphinx">
    {{=XML(current_question['htmlsrc'])}}</div>
    {{ else: }}
    <div class="oneq col-md-6">
        <h3>Congratulations, you have completed this assignment!</h3>
    </div>
    {{ pass }}
    {{ if all_done == "false": }}
    <div class="col-md-6">
        <p>
            Please provide an explanation for why you answered
            <span id="current_answer">__</span>
        </p>
        <textarea id="messageText" rows="6" cols="80"> </textarea> <br />
        <button id="submitReflection" type="button">Submit</button>        <div>
            <!-- <h4>A discussion for you to consider</h4>
            <p id="peerName"></p>
            <p id="peerJust"></p>
            <p id="nextStep"></p> -->
            <div id="llmDiscussion" style="display:none">
              <div id="llmChat"
                  style="background:#f5f5f5;
                          padding:8px;
                          border-radius:4px;
                          max-height:220px;
                          overflow-y:auto;
                          margin-bottom:8px;">
              </div>

              <div style="display:flex; gap:6px;">
                <input id="llmReplyInput"
                      class="form-control"
                      placeholder="Reply to this student…"
                      type="text" />
                <button id="llmReplyBtn" class="btn btn-default">
                  Send
                </button>
              </div>

              <p id="nextStep" style="margin-top:8px; font-style:italic;"></p>
            </div>
        </div>
        <button
          id="readyVote2Btn"
          class="btn btn-default"
          style="display:none; margin-top: 1em;"
          onclick="enableSecondVoteAsync()"
        >
          Vote again
        </button>
    </div>
    {{pass}}
</div>
{{ if has_vote1 and has_reflection and llm_reply: }}
<hr>
<div style="background:#f0f0f0; padding:10px; border-radius:4px;">
  <strong>An LLM peer said:</strong>
  <p>{{=llm_reply}}</p>
</div>
{{ pass }}

{{ if all_done == "false": }}
<div>
    <form action="/peer/peer_async">
        <input type="hidden" name="assignment_id" value="{{=assignment_id}}" />
        <input type="hidden" name="question_num" value="{{=nextQnum}}" />
        <button type="submit" onclick="return checkVoteCount()" style="float: right; margin-bottom: 20px;">Next Question</button>
    </form>
</div>
{{ pass }}
<script>
  window.DISABLE_ASYNC_EXPLAINER = true;
</script>
<script src="/runestone/static/js/peer.js?v={{=request.peer_mtime}}"></script>
<script>
  window._vote2Enabled = false;

  function enableSecondVoteAsync() {
    console.log("PI async: enabling vote 2");

    window._vote2Enabled = true;

    studentSubmittedVote2 = false;

    try {
      const comp = window.componentMap[currentQuestion];
      comp.submitButton.disabled = false;

      const root = document.getElementById(currentQuestion);
      root?.querySelectorAll("input, button").forEach(el => {
        el.disabled = false;
      });
    } catch (e) {
      console.warn("vote 2 enable fallback failed", e);
    }

    const b = document.getElementById("readyVote2Btn");
    if (b) b.style.display = "none";
    const nextStep = document.getElementById("nextStep");
    if (nextStep) {
      nextStep.textContent =
        "Please submit your second vote now. You may keep or change your answer.";
    }
}
</script>
<script>
  (function () {
    const origShowPeerEnableVote2 = window.showPeerEnableVote2;
    window.showPeerEnableVote2 = function () {
      if (window._piReflectionSubmitted) {
        console.log("PI async: suppressing peer.js UI reset after reflection");
        return;
      }
      if (origShowPeerEnableVote2) {
        origShowPeerEnableVote2();
      }
    };
  })();
</script>

<!-- <script src="/runestone/static/js/llmtest.js"></script> -->
 
<script>
(function () {
  const btn = document.getElementById("submitReflection");
  const ta  = document.getElementById("messageText");
  if (!btn || !ta) return;

  const peerNameEl = document.getElementById("peerName");
  const peerJustEl = document.getElementById("peerJust");
  const nextStepEl = document.getElementById("nextStep");

  btn.addEventListener("click", async function () {
  const reflection = (ta.value || "").trim();
  if (!reflection) {
    alert("Please write a short justification first.");
    return;
  }

  let selected = "";
  try {
    selected = answerToString(window.componentMap[currentQuestion].answer);
  } catch {}

  if (typeof logPeerEvent === "function") {
    logPeerEvent({
      sid: eBookConfig.username,
      div_id: currentQuestion,
      event: "reflection",
      act: reflection,
      course_name: eBookConfig.course,
    });
  }

  const discussion = document.getElementById("llmDiscussion");
  const chat = document.getElementById("llmChat");
  const nextStep = document.getElementById("nextStep");

  discussion.style.display = "block";
  chat.innerHTML = "<p><em>Thinking about your explanation…</em></p>";

const mcq = document.querySelector('.mchoice');

const questionText = mcq ? mcq.innerText : "";

window._llmMessages = [
  {
    role: "user",
    content: `i chose answer ${selected}. my explanation was:\n\n${reflection}`
  }
];


const resp = await fetch("/runestone/peer/get_async_llm_reflection", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    div_id: currentQuestion,
    selected_answer: selected,
    messages: window._llmMessages
  })
});

  const data = await resp.json();
  chat.innerHTML = "";

  if (!data.ok) {
    chat.innerHTML = "<p><em>Error talking to peer.</em></p>";
    return;
  }

  appendMsg("assistant", data.reply);

  window._llmMessages.push({
    role: "assistant",
    content: data.reply
  });  
  nextStep.textContent =
    "Discuss this reasoning, then click 'Ready for Vote 2' to vote again.";

  studentSubmittedVote2 = false; 

  

  enableChat(reflection, selected);

});
})(); 
</script>
<script>
function appendMsg(role, text) {
  const chat = document.getElementById("llmChat");
  const p = document.createElement("p");
  p.style.margin = "6px 0";
  p.style.whiteSpace = "pre-wrap";

  p.innerHTML =
    role === "user"
      ? `<strong>You:</strong> ${text}`
      : `<strong>LLM Peer:</strong> ${text}`;

  chat.appendChild(p);
  chat.scrollTop = chat.scrollHeight;
}

function enableChat(reflection, selected) {
  const input = document.getElementById("llmReplyInput");
  const btn = document.getElementById("llmReplyBtn");

  btn.onclick = async () => {
    const msg = input.value.trim();
    if (!msg) return;

    appendMsg("user", msg);
    llmUserMessageCount += 1;

    if (llmUserMessageCount >= 1) {
      const readyBtn = document.getElementById("readyVote2Btn");
      if (readyBtn) readyBtn.style.display = "inline-block";
    }
    input.value = "";

    window._llmMessages.push({
      role: "user",
      content: msg
    });

    const resp = await fetch("/runestone/peer/get_async_llm_reflection", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        div_id: currentQuestion,
        selected_answer: selected,
        messages: window._llmMessages
      })
    });

    const data = await resp.json();
    if (!data.ok) {
      appendMsg("assistant", "(error talking to peer)");
      return;
    }

    appendMsg("assistant", data.reply);

    window._llmMessages.push({
      role: "assistant",
      content: data.reply
    });
  };

  input.addEventListener("keydown", e => {
    if (e.key === "Enter") btn.click();
  });
}
</script>

<script>
    var user = "{{=auth.user.username}}";
    var currentQuestion = "{{=XML(current_question.name)}}";
    document.addEventListener("DOMContentLoaded", function (event) {
        setTimeout(connect, 1000);
    });
    var studentVoteCount = 1;
    var studentSubmittedVote2 = false;
    var vote2done = false;
    var llmUserMessageCount = 0;
    var nextQuestionNumber = {{= nextQnum}};
    var assignId = '{{=assignment_id}}'
    eBookConfig.is_peer_async = true;

    function checkVoteCount() {
        if (studentVoteCount < 2 || studentSubmittedVote2 == false) {
            alert("You must vote twice before moving on");
            return false;
        }
        return true;
    }

    // this cannot happen until the event that indicates components are loaded
    $(document).on("runestone:login-complete", function () {
        llmUserMessageCount = 0;
        logPeerEvent({
            sid: eBookConfig.username,
            div_id: `${assignId}`,
            event: "peer",
            act: "start_async",
            course_name: eBookConfig.course,
        })
        setTimeout(function () {
          const btn = window.componentMap[currentQuestion]?.submitButton;
          if (!btn) return;

          $(btn).off("click.pi_async").on("click.pi_async", function () {
            const currAnswer = window.componentMap[currentQuestion].answer;
            const sAnswer = answerToString(currAnswer);
            $("#current_answer").html(sAnswer);

            if (studentVoteCount === 1 && !window._vote2Enabled) {
              console.log("vote 1 submitted");
              studentVoteCount = 1;
              return;
            }

            if (window._vote2Enabled && !studentSubmittedVote2) {
              console.log("vote 2 submitted");
              studentVoteCount = 2;
              studentSubmittedVote2 = true;
              window._vote2Enabled = false;
            }
            if (studentSubmittedVote2) {
              try {
                const comp = window.componentMap[currentQuestion];
                if (comp && typeof comp.showFeedback === "function") {
                  comp.showFeedback();
                }
              } catch (e) {
                console.warn("Could not show correctness feedback", e);
              }
            }
          });
        }, 2000);
    });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('.pi-ask-btn').forEach(btn => btn.remove());
  });
</script>
