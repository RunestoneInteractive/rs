{% extends "_base.html" %}

{% block title %}Course Creator{% endblock %}

{% block css %}
<style>
    .designer-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 30px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .designer-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .designer-header h1 {
        color: #ab1059;
        font-size: 2.5em;
        font-weight: 300;
        margin: 0;
    }
    .step-title {
        color: #4a90e2;
        font-size: 1.3em;
        margin-top: 30px;
        margin-bottom: 10px;
    }
    .form-section {
        margin-bottom: 25px;
    }
    .alert {
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
    }
    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .btn-primary {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
    }
    .btn-primary:hover {
        background: #357abd;
    }
</style>
{% endblock %}

{% block content %}
<div class="designer-container">
    {% if message %}
    <div class="alert alert-danger" style="display: block;">{{ message }}</div>
    {% endif %}
    <div class="designer-header">
        <h1>Course Creator</h1>
        <p><strong>For Instructors ONLY</strong> If you are an independent learner you DO NOT need to build your own course.<br>
        If you are a student and think that building your own course will show you the answers, YOU ARE WRONG.</p>
    </div>
    <div id="formerrors" class="alert alert-danger"></div>
    <form id="designerForm" method="post">
        <div class="form-section">
            <div class="step-title">Step 1: Institution Info</div>
            <label for="institution">Institution (required)</label>
            <input type="text" class="form-control" name="institution" id="institution" onchange="suggestedCourseName()" required value="{{ submitted.institution if submitted is defined else '' }}">
            <label for="state">United States - State</label>
            <select id="state" name="state" required>
                <option value="">Choose</option>
                {% set selected_state = submitted.state if submitted is defined else '' %}
                <option value="NA" {% if selected_state == 'NA' %}selected{% endif %}>Not in the United States</option>
                <option value="AL" {% if selected_state == 'AL' %}selected{% endif %}>Alabama</option>
                <option value="AK" {% if selected_state == 'AK' %}selected{% endif %}>Alaska</option>
                <option value="AS" {% if selected_state == 'AS' %}selected{% endif %}>American Samoa</option>
                <option value="AZ" {% if selected_state == 'AZ' %}selected{% endif %}>Arizona</option>
                <option value="AR" {% if selected_state == 'AR' %}selected{% endif %}>Arkansas</option>
                <option value="CA" {% if selected_state == 'CA' %}selected{% endif %}>California</option>
                <option value="CO" {% if selected_state == 'CO' %}selected{% endif %}>Colorado</option>
                <option value="CT" {% if selected_state == 'CT' %}selected{% endif %}>Connecticut</option>
                <option value="DE" {% if selected_state == 'DE' %}selected{% endif %}>Delaware</option>
                <option value="DC" {% if selected_state == 'DC' %}selected{% endif %}>District Of Columbia</option>
                <option value="FL" {% if selected_state == 'FL' %}selected{% endif %}>Florida</option>
                <option value="GA" {% if selected_state == 'GA' %}selected{% endif %}>Georgia</option>
                <option value="GU" {% if selected_state == 'GU' %}selected{% endif %}>Guam</option>
                <option value="HI" {% if selected_state == 'HI' %}selected{% endif %}>Hawaii</option>
                <option value="ID" {% if selected_state == 'ID' %}selected{% endif %}>Idaho</option>
                <option value="IL" {% if selected_state == 'IL' %}selected{% endif %}>Illinois</option>
                <option value="IN" {% if selected_state == 'IN' %}selected{% endif %}>Indiana</option>
                <option value="IA" {% if selected_state == 'IA' %}selected{% endif %}>Iowa</option>
                <option value="KS" {% if selected_state == 'KS' %}selected{% endif %}>Kansas</option>
                <option value="KY" {% if selected_state == 'KY' %}selected{% endif %}>Kentucky</option>
                <option value="LA" {% if selected_state == 'LA' %}selected{% endif %}>Louisiana</option>
                <option value="ME" {% if selected_state == 'ME' %}selected{% endif %}>Maine</option>
                <option value="MD" {% if selected_state == 'MD' %}selected{% endif %}>Maryland</option>
                <option value="MA" {% if selected_state == 'MA' %}selected{% endif %}>Massachusetts</option>
                <option value="MI" {% if selected_state == 'MI' %}selected{% endif %}>Michigan</option>
                <option value="MN" {% if selected_state == 'MN' %}selected{% endif %}>Minnesota</option>
                <option value="MS" {% if selected_state == 'MS' %}selected{% endif %}>Mississippi</option>
                <option value="MO" {% if selected_state == 'MO' %}selected{% endif %}>Missouri</option>
                <option value="MP" {% if selected_state == 'MP' %}selected{% endif %}>Northern Mariana Islands</option>
                <option value="MT" {% if selected_state == 'MT' %}selected{% endif %}>Montana</option>
                <option value="NE" {% if selected_state == 'NE' %}selected{% endif %}>Nebraska</option>
                <option value="NV" {% if selected_state == 'NV' %}selected{% endif %}>Nevada</option>
                <option value="NH" {% if selected_state == 'NH' %}selected{% endif %}>New Hampshire</option>
                <option value="NJ" {% if selected_state == 'NJ' %}selected{% endif %}>New Jersey</option>
                <option value="NM" {% if selected_state == 'NM' %}selected{% endif %}>New Mexico</option>
                <option value="NY" {% if selected_state == 'NY' %}selected{% endif %}>New York</option>
                <option value="NC" {% if selected_state == 'NC' %}selected{% endif %}>North Carolina</option>
                <option value="ND" {% if selected_state == 'ND' %}selected{% endif %}>North Dakota</option>
                <option value="OH" {% if selected_state == 'OH' %}selected{% endif %}>Ohio</option>
                <option value="OK" {% if selected_state == 'OK' %}selected{% endif %}>Oklahoma</option>
                <option value="OR" {% if selected_state == 'OR' %}selected{% endif %}>Oregon</option>
                <option value="PA" {% if selected_state == 'PA' %}selected{% endif %}>Pennsylvania</option>
                <option value="PR" {% if selected_state == 'PR' %}selected{% endif %}>Puerto Rico</option>
                <option value="RI" {% if selected_state == 'RI' %}selected{% endif %}>Rhode Island</option>
                <option value="SC" {% if selected_state == 'SC' %}selected{% endif %}>South Carolina</option>
                <option value="SD" {% if selected_state == 'SD' %}selected{% endif %}>South Dakota</option>
                <option value="TN" {% if selected_state == 'TN' %}selected{% endif %}>Tennessee</option>
                <option value="TX" {% if selected_state == 'TX' %}selected{% endif %}>Texas</option>
                <option value="UT" {% if selected_state == 'UT' %}selected{% endif %}>Utah</option>
                <option value="VT" {% if selected_state == 'VT' %}selected{% endif %}>Vermont</option>
                <option value="VA" {% if selected_state == 'VA' %}selected{% endif %}>Virginia</option>
                <option value="VI" {% if selected_state == 'VI' %}selected{% endif %}>Virgin Islands</option>
                <option value="WA" {% if selected_state == 'WA' %}selected{% endif %}>Washington</option>
                <option value="WV" {% if selected_state == 'WV' %}selected{% endif %}>West Virginia</option>
                <option value="WI" {% if selected_state == 'WI' %}selected{% endif %}>Wisconsin</option>
                <option value="WY" {% if selected_state == 'WY' %}selected{% endif %}>Wyoming</option>
            </select>
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="domainname" style="margin-bottom: 0; white-space: nowrap;">Your Institution's Internet Domain</label>
                <input type="text" class="form-control" name="domainname" placeholder="example.edu" id="domainname" style="flex: 1; min-width: 200px;" required value="{{ submitted.domainname if submitted is defined else '' }}">
            </div>
            <label for="timezone">Your Timezone</label>
            <select name="timezone" id="timezone" class="form-control" required>
                {% if submitted is defined and submitted.timezone %}
                    <option value="{{ submitted.timezone }}" selected>{{ submitted.timezone }}</option>
                {% endif %}
            </select>

        </div>
        <div class="form-section">
            <div class="step-title">Step 2: Course Level</div>
            <label for="courselevel">Course Level (required)</label>
            <select id="courselevel" class="form-control" name="courselevel" required>
                {% set selected_level = submitted.courselevel if submitted is defined else 'unknown' %}
                <option value="unknown" disabled {% if selected_level == 'unknown' %}selected{% endif %}>Please Select</option>
                <option value="grad" {% if selected_level == 'grad' %}selected{% endif %}>Graduate</option>
                <option value="undergradadv" {% if selected_level == 'undergradadv' %}selected{% endif %}>Undergraduate Advanced</option>
                <option value="undergradintro" {% if selected_level == 'undergradintro' %}selected{% endif %}>Undergraduate Introductory</option>
                <option value="communitycollege" {% if selected_level == 'communitycollege' %}selected{% endif %}>Community College</option>
                <option value="high" {% if selected_level == 'high' %}selected{% endif %}>High School</option>
                <option value="middle" {% if selected_level == 'middle' %}selected{% endif %}>Middle School</option>
            </select>
        </div>
        <div class="form-section">
            <div class="step-title">Step 3: Choose a Book</div>
            {% for section in sections|sort %}
                <h4>{{ section }}</h4>
                {% for course in course_list %}
                    {% if course.shelf_section == section %}
                        <div class="radio">
                            <label>
                                <input type="radio" name="coursetype" value="{{ course.basecourse }}" {% if submitted is defined and submitted.coursetype == course.basecourse %}checked{% endif %}/>
                                {{ course.title }}{% if course.subtitle %}: {{ course.subtitle }}{% endif %}
                                {% if course.authors %} by {{ course.authors }}{% endif %}
                            </label>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
        <div class="form-section">
            <div class="step-title">Step 4: Course Name</div>
            <label for="projectname">Course Name</label>
            <input type="text" class="form-control" name="projectname" id="projectname" required value="{{ submitted.projectname if submitted is defined else '' }}">
        </div>
        <div class="form-section">
            <div class="step-title">Step 5: Options & Start Date</div>
            <label><input type="checkbox" name="loginreq" value="true" {% if submitted is defined and submitted.loginreq == 'true' %}checked{% else %}checked{% endif %}> Require a username to access this course.</label><br>
            <label><input type="checkbox" name="allowpairs" value="true" {% if submitted is defined and submitted.allowpairs == 'true' %}checked{% endif %}> Enable <strong>experimental</strong> pair programming features.</label><br>
            <label><input type="checkbox" name="instructor" value="yes" {% if submitted is defined and submitted.instructor == 'yes' %}checked{% else %}checked{% endif %}> Make me the Instructor of this course.</label><br>
            <label for="startdate">Term start date</label>
            <input type="text" name="startdate" id="startdate" class="form-control" placeholder="{{ current_date }}" required value="{{ submitted.startdate if submitted is defined else current_date }}">
        </div>
        <div class="form-section">
            <div class="step-title">Step 6 (Optional): Support</div>
            <label><input type="checkbox" name="invoice" value="true" id="invoice-me" {% if submitted is defined and submitted.invoice == 'true' %}checked{% endif %}> Please invoice my school or department for a small support fee of $10 per registered student.</label>
        </div>
        <div class="form-section">
            <div class="step-title">Step 7: Submit</div>
            <input type="submit" class="btn btn-primary" value="Submit">
        </div>
    </form>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script>
    // Populate timezone select with supported timezones and default to browser's timezone
    document.addEventListener('DOMContentLoaded', function() {
        var tzSelect = document.getElementById('timezone');
        if (tzSelect && typeof Intl.supportedValuesOf === 'function') {
            var timezones = Intl.supportedValuesOf('timeZone');
            var browserTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            timezones.forEach(function(tz) {
                var opt = document.createElement('option');
                opt.value = tz;
                opt.textContent = tz;
                if (tz === browserTz) {
                    opt.selected = true;
                }
                tzSelect.appendChild(opt);
            });
        }
    });
    // Minimal domain name validation
    document.getElementById('domainname').addEventListener('change', function() {
        const domain = this.value;
        if (domain.indexOf('.') === -1 || domain.indexOf(' ') !== -1) {
            this.setCustomValidity('Domain name must contain at least one "." and no spaces.');
        } else {
            this.setCustomValidity('');
        }
    });
    document.getElementById('invoice-me').addEventListener('change', function() {
        if (this.checked) {
            let res = confirm("Checking this box means you want us to email you an Invoice (Thank you!!).  If you want to keep using Runestone for free just click cancel");
            if (res === false) {
                this.checked = false;
            }
        }
    });
    function suggestedCourseName() {
        let d = new Date();
        const getSeason = d => Math.floor(((d.getMonth() + 1) / 12 * 4)) % 4;
        let season = ['winter', 'spring', 'summer', 'fall'][getSeason(d)];
        let basecourse = document.getElementById("designerForm").coursetype.value;
        let instid = document.getElementById("institution").value;
        let suggestedCourse = "";
        if (instid) {
            suggestedCourse += instid.toLowerCase().replace(/ /g, '');
        }
        if (basecourse) {
            suggestedCourse += "_" + basecourse.toLowerCase();
        }
        suggestedCourse += "_" + season + (d.getFullYear() % 100);
        document.getElementById("projectname").value = suggestedCourse;
    }
    document.getElementById('startdate').addEventListener('focus', function() {
        $(this).datepicker({format: 'mm/dd/yyyy'});
    });
    document.getElementById('designerForm').addEventListener('submit', function(evt) {
        const errors = [];
        const institution = document.getElementById('institution').value;
        const basecourse = document.getElementById('designerForm').coursetype.value;
        const state = document.getElementById('state').value;
        const level = document.getElementById('courselevel').value;
        const domain = document.getElementById('domainname').value;
        const projectname = document.getElementById('projectname').value;
        const errorDiv = document.getElementById('formerrors');
        errorDiv.innerHTML = "";
        errorDiv.style.display = "none";
        if (!basecourse) {
            errors.push("You must select a book for your course.");
        }
        if (!institution) {
            errors.push("You must provide the name of your Institution.");
        }
        if (level === "unknown") {
            errors.push("Please tell us approximately what level your course is at.");
        }
        if (projectname === "" || projectname.indexOf(" ") !== -1 || projectname.indexOf("/") > -1) {
            errors.push("Your Project Name may not contain spaces or /");
        }
        if (!/^([\x30-\x39]|[\x41-\x5A]|[\x61-\x7A]|[_-])*$/.test(projectname)) {
            errors.push("Your project name can only contain ASCII letters, digits, and - or _.");
        }
        if (domain.indexOf('.') === -1 || domain.indexOf(" ") !== -1) {
            errors.push("Your domain name should contain at least one . and no spaces.");
        }
        if (errors.length > 0) {
            errorDiv.innerHTML = '<ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>';
            errorDiv.style.display = "block";
            evt.preventDefault();
            return false;
        }
        return true;
    });
    document.getElementById('invoice-me').addEventListener('change', function () {
        if (this.checked) {
            let res = confirm("Checking this box means you want us to email you an Invoice (Thank you!!).  If you want to keep using Runestone for free just click cancel");
            if (res === false) {
                this.checked = false;
            }
        }
    });
</script>
{% endblock %}
